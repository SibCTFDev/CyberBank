# Разбор уязвимостей сервиса SibirCTF

Всем привет!

На **SibirCTF** вам удалось порешать сервис, разработанный нашей командой.  
Сервис представлял из себя **Биржу по покупке кибервалюты**.

Получить флаг можно было разными способами:

---

### 1. Накрутка баланса за счет нескольких аккаунтов

Чтобы получить флаг, можно было купить продукт с флагом. Чтобы накопить достаточно денег, можно было создать несколько пользователей и, покупая продукты одного пользователя, собирать у него деньги.

---

### 2. Уязвимость с нулевым балансом

Уязвимость позволяет бесплатно покупать продукт, если его цена равна остатку баланса. То есть если купить продукт на все деньги, то деньги не отнимутся. В функции `updateUser`, условие проверяет, нужно ли обновлять баланс:
```
if (param.balance) user.balance = param.balance;
```
Если после покупки обновленный баланс нулевой, то баланс юзера не обновляется. Таким образом, можно использовать две учетки для быстрой накрутки баланса, после чего купить продукт с флагом.

---

### 3. Цепочка уязвимостей: ReDoS → Race Condition

Самая интересная уязвимость — вы могли в коде увидеть регулярное выражение, которое должно было вас смутить и натолкнуть на мысль, что разработчики заложили в сервис **ReDoS**.  
И это правда, но на самом деле — это была **цепочка уязвимостей**:

```
ReDoS → Race Condition
```

Эксплуатируя данный недостаток, вы могли накручивать деньги на нужном вам аккаунте.

---

### 5. Логин и пароль от базы данных в коде

В коде сервиса были оставлены логин и пароль от базы данных, которая торчит наружу:

![alt text](images/db-credentials-exposed.png)

---

### 4. Фейковая криптография и обфускация

Если внимательно прочитать код сервиса, можно заметить, что криптография, которой шифровались данные сервиса — на самом деле **и не криптография вовсе**.  
Наверное, вас должна была напугать обфускация программного кода, но на самом деле, так как это **TypeScript**, можно было легко расшифровать данные, просто перенеся код дешифратора в сплойт или исполнив его в консоли браузера:

![alt text](images/obfuscation-decryption.png)

---

### 3) Скрытый флаг внутри изображения

Следующей проблемой стал алгоритм генерации картинки — так как алгоритм прятал внутри изображения флаг, вы могли парсить картинки и извлекать из них содержимое:

![alt text](images/image-flag-inside.png)

---

### 5) IDOR через WebSocket

Также присутствовала уязвимость **IDOR через механизм WebSocket'ов**.

---

### Финальная карта уязвимостей

В результате у нас получилась вот такая карта недостатков в сервисе:

![alt text](images/final-vuln-map.png)
